<div class="form-container">
  <!-- Header -->
  <div class="form-header">
    <button class="btn-back" (click)="cancelar()">
      <i-lucide name="arrow-left" class="icon-back"></i-lucide>
      Volver
    </button>
    <h1>
      <i-lucide [name]="isEditMode ? 'pencil' : 'user-plus'" [size]="30" class="icon-title"></i-lucide>
      {{ isEditMode ? 'Editar Usuario' : 'Nuevo Usuario' }}
    </h1>
    <p>{{ isEditMode ? 'Modifica los datos del usuario' : 'Completa el formulario para crear un nuevo usuario del sistema' }}</p>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading-overlay">
    <div class="spinner"></div>
    <p>{{ isEditMode ? 'Cargando usuario...' : 'Guardando usuario...' }}</p>
  </div>

  <!-- Formulario -->
  <form [formGroup]="usuarioForm" (ngSubmit)="onSubmit()" class="usuario-form">

    <!-- Error Message -->
    <div *ngIf="errorMessage" class="error-alert">
      <i-lucide name="alert-triangle" class="icon-alert"></i-lucide>
      {{ errorMessage }}
    </div>

    <!-- Sección: Información del Usuario -->
    <div class="form-section">
      <h2>
        <i-lucide name="user"  [size]="25" class="icon-section"></i-lucide>
        Información del Usuario
      </h2>

      <div class="form-grid">
        <div class="form-group full-width">
          <label for="nombreCompleto">
            <i-lucide name="user" [size]="18" class="icon-label"></i-lucide>
            Nombre Completo *
          </label>
          <input
            type="text"
            id="nombreCompleto"
            formControlName="nombreCompleto"
            placeholder="Ej: Juan Pérez García"
            [class.error]="usuarioForm.get('nombreCompleto')?.invalid && usuarioForm.get('nombreCompleto')?.touched">
          <div class="error-message" *ngIf="usuarioForm.get('nombreCompleto')?.invalid && usuarioForm.get('nombreCompleto')?.touched">
            <i-lucide name="alert-circle" [size]="18" class="icon-error"></i-lucide>
            {{ getFieldErrorMessage('nombreCompleto') }}
          </div>
        </div>

        <div class="form-group">
          <label for="email">
            <i-lucide name="mail" [size]="18" class="icon-label"></i-lucide>
            Email *
          </label>
          <input
            type="email"
            id="email"
            formControlName="email"
            placeholder="ejemplo@genesis.com"
            [class.error]="usuarioForm.get('email')?.invalid && usuarioForm.get('email')?.touched">
          <div class="error-message" *ngIf="usuarioForm.get('email')?.invalid && usuarioForm.get('email')?.touched">
            <i-lucide name="alert-circle" [size]="18" class="icon-error"></i-lucide>
            {{ getFieldErrorMessage('email') }}
          </div>
        </div>

        <div class="form-group">
          <label for="password">
            <i-lucide name="lock" [size]="18" class="icon-label"></i-lucide>
            {{ isEditMode ? 'Nueva Contraseña (dejar vacío para no cambiar)' : 'Contraseña *' }}
          </label>
          <input
            type="password"
            id="password"
            formControlName="password"
            [placeholder]="isEditMode ? 'Dejar vacío para mantener actual' : 'Mínimo 6 caracteres'"
            [class.error]="usuarioForm.get('password')?.invalid && usuarioForm.get('password')?.touched">
          <div class="error-message" *ngIf="usuarioForm.get('password')?.invalid && usuarioForm.get('password')?.touched">
            <i-lucide name="alert-circle" [size]="18" class="icon-error"></i-lucide>
            {{ getFieldErrorMessage('password') }}
          </div>
        </div>

        <div class="form-group">
          <label for="rol">
            <i-lucide name="user-circle" [size]="18" class="icon-label"></i-lucide>
            Rol del Sistema *
          </label>
          <select
            id="rol"
            formControlName="rol">
            <option *ngFor="let rol of roles" [value]="rol.value">
              {{ rol.icon }} {{ rol.label }}
            </option>
          </select>
        </div>
      </div>
    </div>

    <!-- Permisos Info -->
    <div class="permisos-info">
      <h4>
        <i-lucide name="info" [size]="18" class="icon-info"></i-lucide>
        Permisos por Rol:
      </h4>
      <div class="permiso-item" *ngIf="usuarioForm.get('rol')?.value === 'admin'">
        <i-lucide name="shield" [size]="18" class="permiso-icon"></i-lucide>
        <div class="permiso-texto">
          <strong>Administrador:</strong> Acceso completo al sistema. Puede gestionar usuarios, citas, clientes y configurar el sistema.
        </div>
      </div>
      <div class="permiso-item" *ngIf="usuarioForm.get('rol')?.value === 'asistente_legal'">
        <i-lucide name="clipboard-list" [size]="18" class="permiso-icon"></i-lucide>
        <div class="permiso-texto">
          <strong>Asistente Legal:</strong> Puede gestionar citas, administrar clientes y dar soporte general del bufete.
        </div>
      </div>
    </div>

    <!-- Botones -->
    <div class="form-actions">
      <button type="button" class="btn-secondary" (click)="cancelar()" [disabled]="loading">
        Cancelar
      </button>
      <button type="submit" class="btn-primary" [disabled]="usuarioForm.invalid || loading">
        <span *ngIf="!loading">{{ isEditMode ? 'Actualizar Usuario' : 'Crear Usuario' }}</span>
        <span *ngIf="loading">Guardando...</span>
      </button>
    </div>

  </form>
</div>